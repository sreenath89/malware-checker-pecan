from pecan import expose, redirect, conf
from pecan.rest import RestController
from urlparse import urlparse
import ConfigParser
from malwarechecker.model import malware_checker_model as sqlModel
from sqlalchemy.sql import select, text
from sqlalchemy import and_

class VersionController(RestController):

    def __init__(self, data = None):
        '''
        Constructor
        '''
        print "testtted"
        #print type(conf)
        self.mcModel = sqlModel.MalwareCheckerModel()


    @expose(generic=True, template='json')
    def index(self, data):
        return {"v1":{"date": "0000-00-00 00:00:00", "status":"current"}}

    @expose(generic=True, template="json")
    def get(self, data):
        (path, query) = self.split_url(data)
        #Case when port is not present
        parts = path.split(':')
        domain = parts[0]
        port = parts[1]
        result = self.get_details(domain, port, query)
        return result.fetchone()

    @expose(generic=True, template="json")
    def get_all(self):
        return "get all"
        
    @expose(generic=True, template="json")
    def post(self):
        return "post"

    @expose(generic=True, template="json")
    def put(self):
        return "put"

    @expose(generic=True, template="json")
    def delete(self):
        return "delete"

    def split_url(self, url):
        uparts = urlparse(url)
        return uparts.path, uparts.query

    def get_details(self, domain, port, query_string):

        searchStr = "1=1"

        if domain:
            searchStr += " and malware_data.domain = '" + domain + "'"
        
        if port:
            searchStr += " and malware_data.port = '"+ port + "'"
            
        if query_string:
            searchStr += " and malware_data.query_string = '" + query_string + "'"
            
        selectOne = select([self.mcModel.malware_data]).where(text(searchStr))
        return self.mcModel.conn.execute(selectOne)